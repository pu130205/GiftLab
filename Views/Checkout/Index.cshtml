@model GiftLab.Models.CheckoutViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Thanh toán";
    var items = Model?.Items ?? new List<GiftLab.Models.CheckoutItemVM>();
}

<style>
    :root {
        --gl-pink: #ed708a;
        --gl-pink-2: #ff8fab;
        --gl-text: #333;
        --gl-muted: #777;
        --gl-border: #eee;
    }

    .ck-wrap {
        padding: 26px 0 60px;
        background: #fff;
    }

    .ck-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px;
    }

    .ck-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 26px;
        align-items: start;
    }

    .ck-card {
        background: #fff;
        border: 1px solid var(--gl-border);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(237,112,138,.08);
    }

    .ck-title {
        font-weight: 900;
        letter-spacing: .5px;
        color: var(--gl-text);
        margin: 0 0 14px;
        font-size: 16px;
        text-transform: uppercase;
    }

    .ck-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .ck-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

        .ck-field label {
            font-size: 13px;
            color: var(--gl-text);
            font-weight: 800;
        }

        .ck-field input, .ck-field textarea {
            border: 1px solid var(--gl-border);
            border-radius: 12px;
            height: 42px;
            padding: 0 12px;
            outline: none;
            font-size: 14px;
            background: #fff;
        }

        .ck-field textarea {
            height: 110px;
            padding: 10px 12px;
            resize: vertical;
        }

        .ck-field .text-danger {
            font-size: 12px;
            margin-top: 2px;
        }

    .ck-summary {
        background: #fff;
        border: 1px solid rgba(237,112,138,.28);
        border-radius: 18px;
        padding: 16px;
        box-shadow: 0 12px 30px rgba(237,112,138,.06);
    }

    .sum-head {
        display: flex;
        justify-content: space-between;
        padding: 6px 0 10px;
        border-bottom: 1px solid rgba(0,0,0,.06);
        margin-bottom: 10px;
        font-weight: 900;
        color: var(--gl-text);
    }

        .sum-head small {
            font-weight: 800;
            color: var(--gl-muted);
        }

    .sum-item {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .sum-left {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        min-width: 0;
    }

    .sum-thumb {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid rgba(0,0,0,.08);
        background: #fff;
    }

    .sum-name {
        font-weight: 900;
        color: var(--gl-text);
        line-height: 1.15;
    }

    .sum-price {
        font-weight: 900;
        color: var(--gl-text);
        white-space: nowrap;
    }

    .sum-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        color: var(--gl-text);
        font-size: 14px;
    }

        .sum-row b {
            font-weight: 900;
        }

    .sum-total {
        border-top: 1px solid rgba(0,0,0,.08);
        margin-top: 6px;
        padding-top: 10px;
        font-size: 15px;
        font-weight: 900;
        color: var(--gl-pink);
    }

    .pay-methods {
        margin-top: 10px;
        border-top: 1px solid rgba(0,0,0,.06);
        padding-top: 12px;
    }

    .pay-radio {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,.06);
        margin-bottom: 10px;
        background: #fff;
        cursor: pointer;
    }

        .pay-radio input {
            margin-top: 3px;
        }

    .pm-title {
        font-weight: 900;
        color: var(--gl-text);
    }

    .pm-desc {
        font-size: 12px;
        color: var(--gl-muted);
        margin-top: 2px;
    }

    .btn-place {
        width: 100%;
        height: 48px;
        border: none;
        border-radius: 14px;
        background: var(--gl-pink);
        color: #fff;
        font-weight: 900;
        letter-spacing: .6px;
        cursor: pointer;
        margin-top: 12px;
    }

        .btn-place:hover {
            background: var(--gl-pink-2);
        }

    @@media (max-width: 992px) {
        .ck-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="ck-wrap">
    <div class="ck-container">
        <form id="checkoutForm" method="post" action="/Checkout/PlaceOrder">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Mode" />

            <div class="ck-grid">
                <!-- LEFT -->
                <div class="ck-card">
                    <div class="ck-title">Thông tin thanh toán</div>

                    <div class="ck-form-grid">
                        <div class="ck-field" style="grid-column:1 / -1;">
                            <label>Họ và tên *</label>
                            <input asp-for="FullName" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                        </div>

                        <div class="ck-field">
                            <label>Số điện thoại *</label>
                            <input asp-for="Phone" />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>

                        <div class="ck-field">
                            <label>Email *</label>
                            <input asp-for="Email" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="ck-field">
                            <label>Tỉnh/Thành phố *</label>
                            <input asp-for="City" placeholder="Ví dụ: Đồng Tháp / TP. Hồ Chí Minh" />
                            <span asp-validation-for="City" class="text-danger"></span>
                        </div>

                        <div class="ck-field">
                            <label>Phường/Xã *</label>
                            <input asp-for="Ward" placeholder="Ví dụ: Phường Cao Lãnh" />
                            <span asp-validation-for="Ward" class="text-danger"></span>
                        </div>

                        <div class="ck-field" style="grid-column:1 / -1;">
                            <label>Địa chỉ *</label>
                            <input asp-for="Address" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="ck-field" style="margin-top:12px;">
                        <label>Ghi chú đơn hàng (tuỳ chọn)</label>
                        <textarea asp-for="Note" placeholder="Ghi chú về đơn hàng, thời gian giao..."></textarea>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="ck-summary">
                    <div class="sum-head">
                        <div>Đơn hàng của bạn</div>
                        <small>Tạm tính</small>
                        <div>
                            <b id="subtotalValue" data-value="@(Model?.Subtotal ?? 0)">
                                @string.Format("{0:N0} đ", Model?.Subtotal ?? 0)
                            </b>
                        </div>
                    </div>

                    @foreach (var it in items)
                    {
                        <div class="sum-item">
                            <div class="sum-left">
                                <img class="sum-thumb"
                                     src="@Url.Content(string.IsNullOrWhiteSpace(it.ImagePath) ? "~/images/default.png" : it.ImagePath)"
                                     onerror="this.onerror=null;this.src='@Url.Content("~/images/default.png")';" />
                                <div style="min-width:0;">
                                    <div class="sum-name">
                                        @it.Name <span style="color:var(--gl-muted); font-weight:900;">× @it.Quantity</span>
                                    </div>
                                </div>
                            </div>
                            <div class="sum-price">@string.Format("{0:N0} đ", it.LineTotal)</div>
                        </div>
                    }

                    <div class="sum-row">
                        <div>Tạm tính</div>
                        <div><b>@string.Format("{0:N0} đ", Model?.Subtotal ?? 0)</b></div>
                    </div>

                    <div class="sum-row">
                        <div>Vận chuyển</div>
                       <div><b id="shippingFeeText">@string.Format("{0:N0} đ", Model?.ShippingFee ?? 0)</b></div>
                    </div>

                    <div class="sum-row sum-total">
                        <div>Tổng</div>
                        <div id="grandTotalText">@string.Format("{0:N0} đ", Model?.GrandTotal ?? 0)</div>
                    </div>

                    <div class="pay-methods">
                        <label class="pay-radio">
                            <input type="radio" name="PaymentMethod" value="COD" @(Model?.PaymentMethod == "BANK" ? "" : "checked") />
                            <div>
                                <div class="pm-title">Thanh toán khi nhận hàng</div>
                                <div class="pm-desc">Trả tiền mặt khi giao hàng.</div>
                            </div>
                        </label>

                        <label class="pay-radio">
                            <input type="radio" name="PaymentMethod" value="BANK" @(Model?.PaymentMethod == "BANK" ? "checked" : "") />
                            <div>
                                <div class="pm-title">Chuyển khoản ngân hàng</div>
                                <div class="pm-desc">Hiển thị hướng dẫn/QR sau khi đặt hàng.</div>
                            </div>
                        </label>

                        <button type="submit" class="btn-place">ĐẶT HÀNG</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal đặt hàng thành công -->
<div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Thông báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div style="font-size:44px; line-height:1;">🎉</div>
                <p class="mt-2 mb-2 fw-bold">Đặt hàng thành công!</p>

                <p class="mb-3">
                    Mã đơn hàng của bạn là:
                    <span class="fw-bold text-danger" id="orderIdText">#</span>
                </p>

                <div class="d-flex justify-content-center gap-2">
                    <a href="/Account/Dashboard" class="btn btn-danger px-4">Tới Dashboard</a>
                    <a href="/Shop" class="btn btn-outline-secondary px-4">Qua Cửa hàng</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("checkoutForm");
            if (!form) return;

            // ====== AUTO UPDATE SHIPPING FEE ======
            const cityInput = form.querySelector('input[name="City"]');
            const shippingFeeText = document.getElementById("shippingFeeText");
            const grandTotalText = document.getElementById("grandTotalText");
            const subtotalEl = document.getElementById("subtotalValue");

            function formatVnd(n) {
                try { return Number(n || 0).toLocaleString("vi-VN") + " đ"; }
                catch { return (n || 0) + " đ"; }
            }

            async function refreshShipping() {
                if (!cityInput || !shippingFeeText || !grandTotalText || !subtotalEl) return;

                const city = cityInput.value || "";
                try {
                    const res = await fetch("/Checkout/CalcShipping?city=" + encodeURIComponent(city), {
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });
                    const data = await res.json();
                    if (!data || !data.ok) return;

                    const fee = Number(data.shippingFee || 0);
                    const subtotal = Number(subtotalEl.dataset.value || 0);
                    const total = subtotal + fee;

                    shippingFeeText.textContent = formatVnd(fee);
                    grandTotalText.textContent = formatVnd(total);
                } catch (e) {
                    // im lặng, không phá UI
                }
            }

            // debounce để không gọi quá nhiều khi đang gõ
            let t = null;
            if (cityInput) {
                cityInput.addEventListener("input", function () {
                    clearTimeout(t);
                    t = setTimeout(refreshShipping, 250);
                });

                cityInput.addEventListener("blur", refreshShipping);
            }

            // gọi 1 lần lúc load trang (để chắc sync)
            refreshShipping();

            // ====== GIỮ NGUYÊN SUBMIT CỦA BẠN ======
            form.addEventListener("submit", async function (e) {
                e.preventDefault();

                if (window.jQuery && window.jQuery.validator) {
                    if (!window.jQuery(form).valid()) return;
                }

                try {
                    const res = await fetch(form.action, {
                        method: "POST",
                        body: new FormData(form),
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    const data = await res.json();

                    if (!data.ok) {
                        alert(data.message || "Đặt hàng thất bại.");
                        return;
                    }

                    document.getElementById("orderIdText").textContent = "#" + data.orderId;

                    const modalEl = document.getElementById("orderSuccessModal");
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } catch (err) {
                    alert("Lỗi kết nối. Vui lòng thử lại.");
                }
            });
        });
    </script>

}
