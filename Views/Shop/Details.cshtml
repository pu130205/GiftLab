@model GiftLab.Models.ProductDetailViewModel
@{
    ViewData["Title"] = Model.ProductInfo.Name;
}

<style>
    .product-breadcrumb-header {
        background-color: #fff5f8;
        padding: 20px 0;
        margin-bottom: 30px;
        width: 100vw;
        margin-left: calc(50% - 50vw);
    }

    .breadcrumb-text {
        font-size: 14px;
        color: #555;
    }

        .breadcrumb-text b {
            color: #d70025;
            font-weight: bold;
        }

    .product-detail-container {
        display: flex;
        gap: 40px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .product-image-section {
        flex: 1;
        position: relative;
        max-width: 50%;
    }

    .main-product-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        transition: opacity 0.3s;
    }

    .favorite-button-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 10;
    }

    .product-image-section:hover .favorite-button-overlay {
        opacity: 1;
    }

    .favorite-button-overlay img {
        width: 20px;
        height: 20px;
    }

    .favorite-button-overlay.is-favorite img {
        content: url('/images/mini-heartfill.png');
    }

    .favorite-button-overlay:not(.is-favorite) img {
        content: url('/images/mini-heart.png');
    }

    .product-info-section {
        flex: 1;
        padding-top: 10px;
    }

    .product-category {
        color: #fb6f92;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .product-name {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 15px;
    }

    .price-group {
        display: flex;
        align-items: baseline;
        margin-bottom: 20px;
    }

    .product-price {
        font-size: 30px;
        color: #d70025;
        font-weight: bold;
        margin-right: 15px;
    }

    .original-price {
        font-size: 18px;
        color: #999;
        text-decoration: line-through;
    }

    .product-short-description {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        line-height: 1.6;
        color: #555;
    }

    .variant-selection {
        margin-bottom: 20px;
    }

        .variant-selection span {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .variant-selection button {
            padding: 8px 15px;
            margin: 0 10px 10px 0;
            border: 1px solid #ccc;
            background-color: white;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }

            .variant-selection button.selected {
                border-color: #ff8fab;
                background-color: #ff8fab;
                color: white;
            }

            .variant-selection button:disabled {
                background-color: #f7f7f7;
                color: #aaa;
                border-style: dashed;
                cursor: not-allowed;
            }

    .quantity-controls {
        display: flex;
        align-items: center;
        margin: 20px 0;
    }

        .quantity-controls label {
            margin-right: 15px;
            font-weight: 600;
            min-width: 80px;
        }

    .quantity-input {
        display: flex;
        border: 1px solid #ccc;
        border-radius: 4px;
        overflow: hidden;
        margin-right: 20px;
    }

        .quantity-input button {
            padding: 8px 12px;
            border: none;
            background: #f3f3f3;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.1s;
        }

            .quantity-input button:hover {
                background: #eee;
            }

        .quantity-input input {
            width: 50px;
            text-align: center;
            border: none;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            outline: none;
            padding: 8px 0;
        }

    .stock-status-text {
        font-weight: 500;
    }

    .action-buttons button {
        padding: 15px 35px;
        margin-right: 15px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 180px;
        border: none;
    }

    .buy-now-btn {
        background-color: #ff8fab;
        color: white;
    }

        .buy-now-btn:hover {
            background-color: #fb6f92;
            box-shadow: 0 4px 10px rgba(251, 111, 146, 0.3);
        }

    .add-to-cart-btn {
        background-color: #ffe5ec;
        color: #fb6f92;
    }

        .add-to-cart-btn:hover {
            background-color: #fff5f8;
            box-shadow: 0 4px 10px rgba(251, 111, 146, 0.3);
        }

    .action-buttons button:disabled {
        background-color: #f0f0f0;
        color: #aaa;
        border-color: #aaa;
        box-shadow: none;
        cursor: not-allowed;
    }

    .back-to-shop-link {
        font-size: 16px;
        color: #fb6f92;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: color 0.2s;
    }

        .back-to-shop-link:hover {
            color: #e53965;
        }

    .description-section {
        width: 100%;
        margin-top: 40px;
    }

    .tabs-header {
        display: flex;
        border-bottom: 2px solid #eee;
        margin-bottom: 20px;
    }

    .tab-btn {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 600;
        background: none;
        border: none;
        cursor: pointer;
        color: #888;
        position: relative;
        transition: color 0.2s;
        margin-right: 20px;
        text-transform: uppercase;
    }

        .tab-btn.active {
            color: #fb6f92;
        }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 100%;
                height: 4px;
                background-color: #fb6f92;
            }

    .tab-content {
        display: none;
        line-height: 1.8;
        color: #333;
        padding-top: 10px;
    }

        .tab-content.active {
            display: block;
        }

        .tab-content ul {
            font-family: "Noto sans", sans-serif;
            padding-left: 20px;
            list-style-type: disc;
        }

            .tab-content ul li {
                margin-bottom: 10px;
            }

    .review-button {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: 500;
    }

    .related-products-section {
        width: 100%;
    }

    .related-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 30px;
        color: #4e4e4e;
        position: relative;
    }

        .related-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background-color: #fb6f92;
            margin-top: 5px;
        }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .product-description {
        white-space: pre-line;
    }
</style>

<div class="product-breadcrumb-header">
    <div class="product-detail-container" style="margin-bottom: 0; padding-bottom: 0;">
        <p class="breadcrumb-text">
            @Html.Raw(Model.Breadcrumb) / <b>@Model.ProductInfo.Name</b>
        </p>
    </div>
</div>

<div class="product-detail-container">
    <div class="product-image-section">
        <img id="mainImage" src="" alt="@Model.ProductInfo.Name" class="main-product-image" />

        <div id="favoriteButton" class="favorite-button-overlay @(Model.IsFavorite ? " is-favorite" : "")" title="Thêm vào yêu thích">
            <img src="/images/heart-outline.png" alt="Yêu thích" />
        </div>
    </div>

    <div class="product-info-section">
        <p class="product-category">@Model.ProductInfo.Category</p>
        <h1 class="product-name">@Model.ProductInfo.Name</h1>

        <div class="price-group">
            <p class="product-price" id="currentPrice">0₫</p>
            <p class="original-price" id="originalPrice"></p>
        </div>

        <p class="product-short-description">@Model.ShortDescription</p>

        @if (Model.Variants != null && Model.Variants.Any())
        {
            <div class="variant-selection">
                <span>Chọn phân loại:</span>
                <div>
                    @foreach (var variant in Model.Variants)
                    {
                        <button type="button"
                                class="variant-btn @(variant.Id == Model.DefaultVariantId ? "selected" : "")"
                                data-variant-id="@variant.Id"
                                data-price="@variant.Price"
                                data-original-price="@variant.OriginalPrice"
                                data-image-path="@Url.Content(variant.ImagePath)"
                                data-stock-status="@variant.StockStatus"
                                @(variant.StockQuantity <= 0 ? "disabled" : "")>
                            @variant.Name
                        </button>
                    }
                </div>
            </div>
        }

        <div class="quantity-controls">
            <label for="quantity">Số lượng:</label>
            <div class="quantity-input">
                <button type="button" onclick="changeQuantity(-1)">-</button>
                <input type="text" id="quantity" value="1" min="1" max="99" onkeypress="return isNumberKey(event)" />
                <button type="button" onclick="changeQuantity(1)">+</button>
            </div>
            <span id="stockStatusText" class="stock-status-text"></span>
        </div>

        <form method="post" action="/Cart/Add" class="action-buttons">
            @Html.AntiForgeryToken()

            <input type="hidden" name="productId" value="@Model.ProductInfo.Id" />
            <input type="hidden" name="variantId" id="variantId"
                   value="@(Model.DefaultVariantId > 0 ? Model.DefaultVariantId.ToString() : "")" />
            <input type="hidden" name="quantity" id="cartQuantity" value="1" />

            <button id="addToCartBtn" type="submit" class="add-to-cart-btn">
                Thêm vào giỏ hàng
            </button>

            <button id="buyNowBtn" type="button" class="buy-now-btn" onclick="buyNow()">
                Mua ngay
            </button>
        </form>
    </div>
</div>

<div class="product-detail-container" style="margin-top: 30px; margin-bottom: 50px;">
    @{
        var shopIndexUrl = Url.Action("Index", "Shop");
    }
    <a href="@shopIndexUrl" class="back-to-shop-link">
        <span style="font-size: 1.2em;">&larr;</span> Quay về cửa hàng
    </a>
</div>

<div class="product-detail-container">
    <div class="description-section">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="description-content">MÔ TẢ</button>
            <button class="tab-btn" data-tab="review-content">ĐÁNH GIÁ (@Model.ProductInfo.SoldCount)</button>
        </div>

        <div id="description-content" class="tab-content active product-description">
            @Model.ProductInfo.Description
        </div>

        <div id="review-content" class="tab-content">
            <p>Hiện chưa có đánh giá nào cho sản phẩm này.</p>
            <button class="review-button">Viết đánh giá của bạn</button>
        </div>
    </div>
</div>

@if (Model.RelatedProducts != null && Model.RelatedProducts.Any())
{
    <div class="product-detail-container" style="margin-top: 60px; margin-bottom: 80px;">
        <div class="related-products-section">
            <h2 class="related-title">Sản phẩm tương tự</h2>

            <div class="gl-shop-grid related-grid">
                @foreach (var p in Model.RelatedProducts)
                {
                    @await Html.PartialAsync("_ProductCard", p)
                }
            </div>
        </div>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var defaultVariantId = @Model.DefaultVariantId;

    $(document).ready(function () {
        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
        }

        function updateProductInfo(variantElement) {
            var price = parseFloat($(variantElement).data('price'));
            var originalPrice = parseFloat($(variantElement).data('original-price'));
            var imagePath = $(variantElement).data('image-path');
            var stockStatus = $(variantElement).data('stock-status');

            $('#mainImage').attr('src', imagePath);
            $('#currentPrice').text(formatCurrency(price));

            if (originalPrice && originalPrice > price) $('#originalPrice').text(formatCurrency(originalPrice));
            else $('#originalPrice').text('');

            $('#stockStatusText').text('(' + stockStatus + ')');
            var isAvailable = stockStatus === 'Còn hàng';

            if (!isAvailable) {
                $('#stockStatusText').css('color', 'red');
                $('#addToCartBtn, #buyNowBtn, #quantity').prop('disabled', true);
            } else {
                $('#stockStatusText').css('color', 'green');
                $('#addToCartBtn, #buyNowBtn, #quantity').prop('disabled', false);
            }

            $('.variant-btn').removeClass('selected');
            $(variantElement).addClass('selected');

            const vid = $(variantElement).data('variant-id');
            $('#variantId').val(vid && vid > 0 ? vid : "");
        }

        $('.variant-btn').on('click', function () {
            if ($(this).is(':disabled')) return;
            updateProductInfo(this);
        });

        $('#favoriteButton').on('click', function () {
            $(this).toggleClass('is-favorite');
        });

        var defaultVariantElement = $('.variant-btn[data-variant-id="' + defaultVariantId + '"]');
        if (defaultVariantElement.length > 0) updateProductInfo(defaultVariantElement[0]);

        $('.tab-btn').on('click', function () {
            var targetTabId = $(this).data('tab');
            $('.tab-content').removeClass('active');
            $('.tab-btn').removeClass('active');
            $('#' + targetTabId).addClass('active');
            $(this).addClass('active');
        });

        $('#description-content').addClass('active');
    });

    function changeQuantity(change) {
        var quantityInput = $('#quantity');
        var current = parseInt(quantityInput.val()) || 1;
        var max = parseInt(quantityInput.attr('max')) || 99;
        var min = parseInt(quantityInput.attr('min')) || 1;

        var newQuantity = current + change;
        if (newQuantity < min) newQuantity = min;
        if (newQuantity > max) newQuantity = max;

        quantityInput.val(newQuantity);
        $('#cartQuantity').val(newQuantity);
    }

    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : event.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) return false;
        return true;
    }
</script>

@section Scripts {
    <script>
        (function () {
            const isAuth = @((User.Identity?.IsAuthenticated ?? false).ToString().ToLower());

            function showLoginModal() {
                const el = document.getElementById("loginRequiredModal");
                if (!el) return;
                const modal = new bootstrap.Modal(el);
                modal.show();
            }

            // Chặn submit AddToCart khi chưa login
            const form = document.querySelector('form[action="/Cart/Add"]');
            if (form) {
                form.addEventListener("submit", function (e) {
                    if (!isAuth) {
                        e.preventDefault();
                        showLoginModal();
                    }
                });
            }

            // Buy now
            window.buyNow = function () {
                if (!isAuth) {
                    showLoginModal();
                    return;
                }

                const productId = @Model.ProductInfo.Id;
                const quantity = parseInt(document.getElementById("quantity")?.value || "1");
                const variantId = document.getElementById("variantId")?.value;

                let url = `/Checkout/BuyNow?productId=${productId}&quantity=${quantity}`;
                if (variantId && variantId !== "" && variantId !== "0") url += `&variantId=${variantId}`;

                window.location.href = url;
            };
        })();
    </script>
}